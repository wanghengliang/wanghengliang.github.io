I"<p>MacOS动态壁纸制作</p>

<h3 id="介绍">介绍</h3>
<p>macOS 10.14 (Mojave)的一项用户界面的新功能——动态桌面（dynamic desktop）受到的关注则少得多。这是一项默认关闭的功能，启用方法是打开「系统偏好设置 - 桌面与屏幕保护程序」，从「动态桌面」中选择系统自带的两套壁纸之一。</p>

<p>乍听起来，这确实并不稀奇，也没有任何技术门槛。随时间变化切换壁纸是很多桌面美化软件的基础功能，更别提十多年前的 Windows Vista 就已经原生支持 视频壁纸 了。</p>

<p>但问题实际上并不只是 「按时间切换图片」 这么简单。因为，晨昏变化的节奏并非一成不变，而是随着四季变换各有不同。除非生活在赤道或者极地，从夏到冬一定是昼渐短、夜渐长的。如果全年都按照一个节拍切换壁纸，其效果在绝大多数日子里都将跟真实景象不同步。</p>

<p>随着季节推移变化的不只是昼夜长度，还有 太阳高度 。显然，夏天的太阳比冬天的同一时间要「高」。太阳高度还与纬度有关。假如你生活在北京，而系统在中午时分给你换上了一张「阳光从头顶直射」的壁纸，你其实应该有一种违和感才对，因为北京根本不会有 90 度的日照。地处北纬 40 度的北京，太阳最高也只能达到 73.5 度，并且一年只有一次，时间是在夏至那天的（地方时）正午。</p>

<p>可见，要真正让桌面和窗外的光照 同步 变化，机械地踩着时间点换图片是远远不够的。理想情况下，同一组图片的切换节奏应当呼应太阳运动、在四季各不相同，并且根据用户的地理位置和日期，有选择地「跳过」一些不符合实际情况的照片。</p>

<h3 id="动态桌面的实现机制">动态桌面的实现机制</h3>

<p>macOS Mojave 的动态桌面充分考虑了上述问题。在苹果的实现方案中，壁纸的切换不是以时间为标准，而是以 太阳方位 为标准。具体而言：</p>

<p>每套壁纸包含 16 张静态图片（实验表明似乎可以更少，但不能更多）。
每张静态图片都被标记了对应的太阳方位。定位的方式是所谓的 「地平坐标系」 ，即用高度角（Altitude，定义为太阳和地平线的夹角）和方位角（Azimuth，定义为太阳按顺时针方向偏离正北的角度）两个值确定太阳在天球中的位置。
启用后，系统将会根据用户的位置和时间计算太阳的实时方位，并与每张壁纸所记载的信息进行比对，将其中与此时此地太阳位置最近似的那一张作为桌面背景。</p>

<p>地平面坐标系图示如下：</p>

<p>实际例子可能更有助于理解动态桌面的机制。我目前的所在地处于北纬 40 度，与北京基本相同。10 月 5 日的早上 6:30 尚未日出，此时的太阳高度为 -6.75 度，方位为 90.6 度。启用「沙丘」动态壁纸后，桌面显示为该系列中的第三张。根据壁纸的元信息（后文将说明方法），这张照片是在太阳高度 -4.25 度，方位 86.34 度的场景下拍摄的，与现实环境非常接近。如果将系统日期拨回三个月前的 7 月 5 日，会发现壁纸变成了系列中的第五张（太阳高度为 7 度）。的确，夏天的这一时刻，太阳应该已经升起了。</p>

<p>再将日期调回 10 月 5 日。这一天，太阳在下午 12:48 时达到最高位置。但如果试着慢慢将时钟调过这一时刻，会发现壁纸并没有切换为系列中最明亮的第八张，而是直接从第七张跳到了第九张。原因在于，秋天的太阳即使在正午也只能达到 45 度左右，而第八张壁纸是在太阳处于 53 度时拍摄的，因此不会被显示。相反，在 Mojave 刚刚开始公测的七月时，这张壁纸会从上午 10:40 左右开始持续显示约五个小时。</p>

<p>更有趣的是，在另一套动态壁纸 Solar Gradients 中，一张图片对应的太阳高度为 88.4 度。如上所述，由于北纬 40 度的太阳全年最高也只能达到 73.5 度，我将始终不会看到这张最亮的壁纸被用作桌面——它实际上成了热带地区用户的「会员特权」。</p>

<h3 id="壁纸资源技术细节与自制方法">壁纸资源、技术细节与自制方法</h3>

<p>将动态壁纸的配置信息转为可读模式，这样，苹果在 Mojave 的动态壁纸中设置的机关就展现出全貌了。可以看到，在 si 根键下，每张静态图片被都标记了 i 、 a 、 z 三个键值，分别对应照片的序号、拍摄时的太阳高度角和方位角。</p>

<p>此外，沙丘壁纸还有一个 ap 根键，其下的 l 和 d 两个值分别指定了在设置中启用亮暗两种「静态」选项时，要显示的图片序号。（太阳渐变壁纸没有 ap 根键，因此在设置中没有「静态」选项。）</p>

<p>至此，原理上的铺垫就全部完成了，最后要解决的就是如何据此自行制作动态壁纸。显然，这涉及到格式转换、信息编码等操作，全部手工完成会非常繁琐。好在，已经有开发者制作出了 <a href="https://github.com/mczachurski/wallpapper">命令行工具</a> ，可以使用 Homebrew 安装：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ brew tap mczachurski/wallpapper &amp;&amp; brew install wallpapper
</code></pre></div></div>

<p>这里简单介绍一下该工具的使用方法。首先，将想要制作成动态壁纸的图片文件按序号依次命名。然后在 同一目录 下创建一个 JSON 文件（如 config.json ），在其中逐行指定照片的参数：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
{"fileName":"1.png","isPrimary":false,"isForLight":false,"isForDark":false,"altitude":-0.34275283875350282,"azimuth":270.9334057827345},
…
{"fileName":"16.png","isPrimary":false,"isForLight":false,"isForDark":false,"altitude":-38.04743388682423,"azimuth":53.509085812513092}
]
</code></pre></div></div>

<p>其中， fileName 为文件名， isPrimary 表示是否将图片用作记录整套壁纸元信息的「首要图片」， isForLight 和 isForDark 分别指是否用作开启亮/暗两种「静态」选项时使用的图片， altitude 和 azimuth 则是照片对应的高度角和方位角。</p>

<p>准备完毕后，在终端执行 wallpapper -i config.json 即可获得打包好的 HEIC 格式动态壁纸。</p>

<p>想要省事的读者也可以使用此 <a href="https://cl.ly/1b0449fdfb89/dynwp-config-sample.json">模板配置文件</a> ，其内容原样复制了系统自带的沙丘壁纸中图片的参数，只需找 16 张光线情况与该套壁纸类似的图片，依次命名为 1.png 到 16.png ，并用上述工具制作即可。</p>

<h3 id="参考资料">参考资料</h3>

<p><a href="https://sspai.com/post/47390">macOS Mojave 的动态桌面，可不只是「定时换壁纸」这么简单</a></p>

:ET